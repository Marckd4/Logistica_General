<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Consulta por Ubicación (Escaneo)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode@2.3.7/html5-qrcode.min.js"></script>
</head>
<body>
    <div class="container mt-4">
    <h3>📷 Escanear ubicación con cámara</h3>

    <div id="reader" style="width: 100%; max-width: 400px; margin-bottom: 1rem;"></div>

    <form method="get" id="formScan">
        <input type="hidden" name="codigo" id="codigoScan">
    </form>

    {% if codigo %}
        <h5>Productos en la ubicación: <strong>{{ codigo }}</strong></h5>
        {% if productos %}
            <table class="table table-bordered table-striped">
                <thead class="table-dark text-center">
                    <tr>
                        <th>ID</th>
                        <th>Descripción</th>
                        <th>Cod_EAN</th>
                        <th>Empresa</th>
                        <th>Stock</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in productos %}
                    <tr>
                        <td>{{ p.id }}</td>
                        <td>{{ p.descripcion }}</td>
                        <td>{{ p.cod_ean }}</td>
                        <td>{{ p.empresa }}</td>
                        <td>{{ p.stock_fisico }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div class="alert alert-warning">No hay productos en esta ubicación.</div>
        {% endif %}
    {% endif %}
</div>


</body>

<script>
    function onScanSuccess(decodedText, decodedResult) {
        // Insertar el valor escaneado en el input oculto
        document.getElementById("codigoScan").value = decodedText;

        // Enviar automáticamente el formulario
        document.getElementById("formScan").submit();
    }

    function onScanFailure(error) {
        // Ignorar errores temporales
    }

    const html5QrCode = new Html5Qrcode("reader");

    Html5Qrcode.getCameras().then(devices => {
        if (devices && devices.length) {
            const cameraId = devices[0].id;
            html5QrCode.start(
                cameraId,
                {
                    fps: 10,
                    qrbox: 250
                },
                onScanSuccess,
                onScanFailure
            );
        }
    }).catch(err => {
        console.error("No se pudo iniciar la cámara: ", err);
    });
</script>

</html>
