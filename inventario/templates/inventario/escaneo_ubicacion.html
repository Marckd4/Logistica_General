<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Escaneo Ubicaci√≥n</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/html5-qrcode@2.3.7/html5-qrcode.min.js"></script>
</head>
<body>
<div class="container mt-4">
    <h3>üìç Escanea la ubicaci√≥n con c√°mara o lector USB</h3>
    <a href="{% url 'inicio' %}" class="btn btn-secondary mt-3">‚¨ÖÔ∏è Volver al inicio</a>

    <!-- DIV para la c√°mara -->
    <div id="reader" style="width: 100%; max-width: 400px; margin-bottom: 1rem;"></div>

    <!-- Formulario que recibe el c√≥digo escaneado -->
    <form method="get" id="formScan">
        <!-- Campo oculto para enviar el c√≥digo escaneado -->
        <input type="hidden" name="codigo" id="codigoScan" />
        
        <!-- Campo visible para lector USB -->
        <input
            type="text"
            id="codigoInput"
            placeholder="Escanea o escribe el c√≥digo aqu√≠"
            class="form-control mb-3"
            autocomplete="off"
            autofocus
        />
    </form>

    <!-- Tabla con productos encontrados -->
    {% if codigo %}
        <h5>Productos en la ubicaci√≥n: <strong>{{ codigo }}</strong></h5>

        {% if productos %}
            <table class="table table-bordered table-striped">
                <thead class="table-dark text-center">
                    <tr>
                        <th>ID</th>
                        <th>Cod_Sistema</th>
                        <th>Descripci√≥n</th>
                        <th>Cod_DUN</th>
                        <th>Cod_EAN</th>
                        <th>Empresa</th>
                        <th>Stock</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in productos %}
                    <tr>
                        <td>{{ p.id }}</td>
                        <td>{{ p.cod_sistema }}</td>
                        <td>{{ p.descripcion }}</td>
                        <td>{{ p.cod_dun }}</td>
                        <td>{{ p.cod_ean }}</td>
                        <td>{{ p.empresa }}</td>
                        <td>{{ p.stock_fisico }}</td>
                        <td class="text-center">
                        <a href="{% url 'editar_producto' p.id %}" class="btn btn-warning btn-sm">‚úèÔ∏è Editar</a>
                        <a href="{% url 'eliminar_producto' p.id %}" class="btn btn-danger btn-sm">üóëÔ∏è Eliminar</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div class="alert alert-warning">No hay productos en esta ubicaci√≥n.</div>
        {% endif %}
    {% endif %}
</div>

<script>
    // Escaneo con c√°mara usando Html5Qrcode
    function onScanSuccess(decodedText, decodedResult) {
        document.getElementById('codigoScan').value = decodedText;
        document.getElementById('formScan').submit();
    }

    function onScanFailure(error) {
        // No hacer nada por ahora
    }

    const html5QrCode = new Html5Qrcode("reader");

    Html5Qrcode.getCameras()
        .then(devices => {
            if (devices && devices.length) {
                const cameraId = devices[0].id;
                html5QrCode.start(
                    cameraId,
                    { fps: 10, qrbox: 250 },
                    onScanSuccess,
                    onScanFailure
                );
            }
        })
        .catch(err => {
            console.error("No se pudo iniciar la c√°mara:", err);
        });

    // Escaneo con lector USB (input de texto)
    const input = document.getElementById('codigoInput');
    input.addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            document.getElementById('codigoScan').value = input.value.trim();
            document.getElementById('formScan').submit();
        }
    });
</script>
</body>
</html>
